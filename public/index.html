<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Birka Sport-schema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card-bg: #0b1220;
      --accent: #3b82f6;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --priority: #facc15;

      --football: rgba(34,197,94,0.16);
      --hockey: rgba(56,189,248,0.16);
      --motorsport: rgba(248,113,113,0.16);
      --dart: rgba(192,132,252,0.16);
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    header {
      padding: 18px 20px 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.92);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      z-index: 20;
    }

    .header-left {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    header small {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .header-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .toggle-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .toggle-btn.active {
      border-color: var(--priority);
      background: radial-gradient(circle at top, rgba(250,204,21,0.2), rgba(15,23,42,0.95));
      box-shadow: 0 0 0 1px rgba(250,204,21,0.6);
    }

    #updated {
      color: var(--muted);
      font-size: 0.8rem;
      text-align: right;
    }

    /* Next-up bar */
    #next-up-bar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 8px 18px 4px;
      font-size: 0.85rem;
      color: #fef9c3;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #next-up-bar.hidden {
      display: none;
    }

    #next-up-bar span.label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
    }

    #next-up-bar span.content {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.5);
      background: radial-gradient(circle at left, rgba(250,204,21,0.22), rgba(15,23,42,0.95));
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Lane overview */
    #lanes-overview {
      max-width: 1200px;
      margin: 4px auto 0;
      padding: 0 18px 4px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .lane-card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      font-size: 0.75rem;
    }

    .lane-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .lane-body {
      max-height: 60px;
      overflow: hidden;
      color: var(--muted);
    }

    .lane-match {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Layout for main cards */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 8px 18px 28px;
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    /* Day card */
    .day {
      background: var(--card-bg);
      padding: 14px 14px 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
    }

    .day-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }

    .day-sub {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    /* Match card */
    .match {
      padding: 7px 8px;
      border-top: 1px solid rgba(31,41,55,0.85);
      border-radius: 12px;
      cursor: pointer;
      transition: box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease, transform 0.1s ease;
      position: relative;
    }

    .match:hover {
      background: rgba(15,23,42,0.9);
      box-shadow: 0 0 0 1px rgba(55,65,81,0.7);
      transform: translateY(-1px);
    }

    .match.priority {
      border: 2px solid var(--priority);
      box-shadow: 0 0 0 1px rgba(250,204,21,0.45);
      background: radial-gradient(circle at top left, rgba(250,204,21,0.16), transparent 55%);
    }

    /* sport color tints */
    .match.football {
      background-image: linear-gradient(to right, var(--football), transparent);
    }

    .match.hockey {
      background-image: linear-gradient(to right, var(--hockey), transparent);
    }

    .match.motorsport {
      background-image: linear-gradient(to right, var(--motorsport), transparent);
    }

    .match.dart-sport {
      background-image: linear-gradient(to right, var(--dart), transparent);
    }

    .time {
      color: var(--accent);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .teams {
      margin-top: 3px;
      font-size: 0.9rem;
    }

    .competition {
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Meta row: channel + BB tags */
    .meta-row {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text);
      background: rgba(15,23,42,0.9);
      user-select: none;
    }

    .chip.channel {
      border-color: rgba(96,165,250,0.7);
      background: rgba(37,99,235,0.18);
    }

    .chip.bb-tag {
      border-color: rgba(156,163,175,0.8);
      cursor: pointer;
    }

    .chip.bb-tag.active {
      border-color: var(--priority);
      box-shadow: 0 0 0 1px rgba(250,204,21,0.6);
      background: radial-gradient(circle at top left, rgba(250,204,21,0.25), transparent 70%);
      color: #fef9c3;
    }

    .nomatches {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      header { padding-inline: 12px; }
      main { padding-inline: 10px; }
      #lanes-overview { padding-inline: 10px; }
      #next-up-bar { padding-inline: 10px; }
      .header-right { align-items: flex-start; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-left">
      <small>Birka Bowling &amp; Dart</small>
      <h1>Sportschema</h1>
    </div>
    <div class="header-right">
      <div class="header-buttons">
        <button id="today-toggle" class="toggle-btn" type="button">Visa endast idag</button>
        <button id="priority-toggle" class="toggle-btn" type="button">Visa endast prioriterade</button>
      </div>
      <div id="updated">Laddar…</div>
    </div>
  </header>

  <div id="next-up-bar" class="hidden">
    <span class="label">Nästa</span>
    <span class="content"></span>
  </div>

  <section id="lanes-overview"></section>

  <main id="days"></main>

  <script>
    const WEEK = ["Söndag","Måndag","Tisdag","Onsdag","Torsdag","Fredag","Lördag"];
    const MONTH = ["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];

    function formatDate(iso) {
      const d = new Date(iso + "T12:00:00");
      return WEEK[d.getDay()] + " " + d.getDate() + " " + MONTH[d.getMonth()];
    }

    function classifySport(competition) {
      const c = (competition || "").toLowerCase();
      if (c.includes("allsvenskan") || c.includes("premier") || c.includes("champions") || c.includes("efl") || c.includes("vm")) {
        return "football";
      }
      if (c.includes("shl") || c.includes("hockeyallsvenskan")) {
        return "hockey";
      }
      if (c.includes("f1") || c.includes("indycar")) {
        return "motorsport";
      }
      if (c.includes("dart")) {
        return "dart-sport";
      }
      return "";
    }

    // Global state
    let fullData = null;
    let showTodayOnly = false;
    let showOnlyPriority = false;
    let tagState = {}; // { [matchId]: {BB1:true, BB2:false,...} }

    async function togglePriority(id, row) {
      if (!id) return;
      try {
        const res = await fetch("/priorities/toggle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (!data.ok) return;

        const active = data.eventIds.includes(String(id));
        row.classList.toggle("priority", active);
        // also update in memory so filters remain consistent on next render()
        const day = fullData.days.find(d => d.matches.some(m => m.id === id));
        if (day) {
          const m = day.matches.find(mm => mm.id === id);
          if (m) m.priority = active;
        }
      } catch (err) {
        console.error("Failed to toggle priority", err);
      }
    }

    async function toggleBBTag(matchId, tag, chip) {
      if (!matchId || !tag) return;
      try {
        const current = tagState[matchId]?.[tag] || false;
        tagState[matchId][tag] = !current;
        chip.classList.toggle("active", !current);

        await fetch("/tags/toggle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: matchId, tag })
        });
      } catch (err) {
        console.error("Failed to toggle tag", err);
      }
    }

    function computeNextMatch(allDays, priorityOnly) {
      const now = new Date();
      let best = null;

      allDays.forEach(d => {
        (d.matches || []).forEach(m => {
          if (priorityOnly && !m.priority) return;
          if (!m.time) return;
          const dt = new Date(d.date + "T" + m.time + ":00");
          if (dt < now) return;
          if (!best || dt < best.when) {
            best = { when: dt, date: d.date, match: m };
          }
        });
      });

      return best;
    }

    function render() {
      if (!fullData) return;

      const daysEl = document.getElementById("days");
      const upd = document.getElementById("updated");
      const lanesEl = document.getElementById("lanes-overview");
      const nextBar = document.getElementById("next-up-bar");
      const nextContent = nextBar.querySelector(".content");

      daysEl.innerHTML = "";
      lanesEl.innerHTML = "";

      const allDays = fullData.days || [];
      const todayISO = new Date().toISOString().slice(0, 10);

      // -------- Next up bar (always from all days, respect priority filter) --------
      const next = computeNextMatch(allDays, showOnlyPriority);
      if (next) {
        nextBar.classList.remove("hidden");
        const t = next.when.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
        const m = next.match;
        const channelPart = m.channel ? `, ${m.channel}` : "";
        nextContent.textContent = `${t} – ${m.home} – ${m.away} (${m.competition}${channelPart})`;
      } else {
        nextBar.classList.add("hidden");
      }

      // -------- Date filtering (today only / next date) --------
      const dates = allDays.map(d => d.date);
      let targetDate = todayISO;
      if (showTodayOnly && allDays.length) {
        if (!dates.includes(todayISO)) {
          const future = dates.filter(d => d >= todayISO).sort();
          targetDate = future.length ? future[0] : dates[0];
        }
      }

      const baseDays = allDays.filter(d =>
        !showTodayOnly || d.date === targetDate
      );

      // -------- Lane overview structure --------
      const lanes = { BB1: [], BB2: [], BB3: [], BB4: [] };

      // -------- Build day cards & fill lane data --------
      baseDays.forEach(d => {
        let matches = d.matches;
        if (showOnlyPriority) {
          matches = matches.filter(m => m.priority);
        }

        // For all-days view + "only priority": skip empty days
        if (showOnlyPriority && matches.length === 0 && !showTodayOnly) {
          return;
        }

        // Fill lane data from these matches
        matches.forEach(m => {
          if (!tagState[m.id]) {
            tagState[m.id] = { BB1:false, BB2:false, BB3:false, BB4:false };
            if (Array.isArray(m.tags)) {
              m.tags.forEach(t => {
                if (tagState[m.id].hasOwnProperty(t)) tagState[m.id][t] = true;
              });
            }
          }
          ["BB1","BB2","BB3","BB4"].forEach(tag => {
            if (tagState[m.id][tag]) {
              lanes[tag].push({
                date: d.date,
                time: m.time,
                match: m
              });
            }
          });
        });

        // Day card
        const card = document.createElement("section");
        card.className = "day";

        const count = matches.length;
        const subText = showOnlyPriority
          ? (count ? `${count} prioriterade matcher` : "Inga prioriterade matcher.")
          : (count ? `${count} matcher` : "Inga matcher vi får visa.");

        card.innerHTML = `
          <div class="day-title">${formatDate(d.date)}</div>
          <div class="day-sub">${subText}</div>
        `;

        matches.forEach(m => {
          const row = document.createElement("div");
          const sportClass = classifySport(m.competition);
          row.className = "match" + (sportClass ? " " + sportClass : "");
          if (m.priority) row.classList.add("priority");
          row.dataset.id = m.id;

          // Init tag state from backend if still missing
          if (!tagState[m.id]) {
            tagState[m.id] = { BB1:false, BB2:false, BB3:false, BB4:false };
            if (Array.isArray(m.tags)) {
              m.tags.forEach(t => {
                if (tagState[m.id].hasOwnProperty(t)) tagState[m.id][t] = true;
              });
            }
          }

          const container = document.createElement("div");
          container.innerHTML = `
            <div class="time">${m.time}</div>
            <div class="teams">${m.home} – ${m.away}</div>
            <div class="competition">${m.competition}</div>
          `;
          row.appendChild(container);

          const meta = document.createElement("div");
          meta.className = "meta-row";

          if (m.channel) {
            const channelSpan = document.createElement("span");
            channelSpan.className = "chip channel";
            channelSpan.textContent = m.channel;
            meta.appendChild(channelSpan);
          }

          ["BB1","BB2","BB3","BB4"].forEach(tag => {
            const chip = document.createElement("span");
            chip.className = "chip bb-tag";
            chip.textContent = tag;
            if (tagState[m.id][tag]) chip.classList.add("active");

            chip.addEventListener("click", (ev) => {
              ev.stopPropagation();
              toggleBBTag(m.id, tag, chip);
            });

            meta.appendChild(chip);
          });

          row.appendChild(meta);
          row.addEventListener("click", () => togglePriority(m.id, row));
          card.appendChild(row);
        });

        daysEl.appendChild(card);
      });

      // -------- Render lane overview --------
      const laneOrder = ["BB1","BB2","BB3","BB4"];
      laneOrder.forEach(key => {
        const list = lanes[key];

        // Sort by datetime
        list.sort((a, b) => {
          const da = new Date(a.date + "T" + (a.time || "00:00") + ":00");
          const db = new Date(b.date + "T" + (b.time || "00:00") + ":00");
          return da - db;
        });

        const card = document.createElement("div");
        card.className = "lane-card";

        const title = document.createElement("div");
        title.className = "lane-title";
        title.textContent = key;
        card.appendChild(title);

        const body = document.createElement("div");
        body.className = "lane-body";

        if (list.length === 0) {
          body.textContent = "Ingen match tilldelad.";
        } else {
          list.forEach(item => {
            const line = document.createElement("div");
            line.className = "lane-match";
            const t = item.time || "??:??";
            line.textContent = `${item.date} ${t} – ${item.match.home} – ${item.match.away}`;
            body.appendChild(line);
          });
        }

        card.appendChild(body);
        lanesEl.appendChild(card);
      });

      // -------- Updated label --------
      if (fullData.generatedAt) {
        const gd = new Date(fullData.generatedAt);
        upd.textContent =
          "Uppdaterad " +
          gd.toLocaleString("sv-SE", { weekday: "short", hour: "2-digit", minute: "2-digit" }) +
          " • Auto-uppdateras var 2:e minut";
      } else {
        upd.textContent = "Schema uppdaterat • Auto-uppdateras var 2:e minut";
      }
    }

    async function load() {
      try {
        const res = await fetch("/schedule");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        fullData = data;
        // tagState rebuilt from server m.tags when rendering
        render();
      } catch (err) {
        console.error(err);
        document.getElementById("updated").textContent = "Fel vid hämtning";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const todayBtn = document.getElementById("today-toggle");
      const priorityBtn = document.getElementById("priority-toggle");

      todayBtn.addEventListener("click", () => {
        showTodayOnly = !showTodayOnly;
        todayBtn.classList.toggle("active", showTodayOnly);
        todayBtn.textContent = showTodayOnly ? "Visa alla dagar" : "Visa endast idag";
        render();
      });

      priorityBtn.addEventListener("click", () => {
        showOnlyPriority = !showOnlyPriority;
        priorityBtn.classList.toggle("active", showOnlyPriority);
        priorityBtn.textContent = showOnlyPriority
          ? "Visa alla matcher"
          : "Visa endast prioriterade";
        render();
      });

      load();

      // Auto-refresh every 2 minutes
      setInterval(load, 2 * 60 * 1000);
    });
  </script>
</body>
</html>
